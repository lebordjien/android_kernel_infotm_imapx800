/*
 * imapx800-dmic-soft.c
 *
 * say pdm data -> pcm data
 * by Larry Liu
 */

#include <linux/cache.h>
#include "imapx800-dmic-soft.h"


/* cic_filter 
 *
 * this function is from cic_filter.S
 * input_len is counted by 32bit
 */
extern void cic_filter(uint32_t *input, short *output,uint32_t input_len, 
			struct cic_info *cic);

/* fir_filter
 *
 * this function is from fir_filter.S
 * input_size is counted by 16bit
 */
extern void fir_filter(short *input, short *output,uint32_t input_size, 
			struct fir_16 *fir); 
extern void fir_filter1(short *input, short *output,uint32_t input_size, 
			struct fir_16 *fir); 


/*
static const short comp_coeffs_11[12] = {
	261, -145, -2275, -419, 10203, 17502, 10203, -419, -2275, -145, 261, 0 
};

static const short halfband_coeffs_11[12] = {
	167, 0, -1383, 0, 9514, 16384, 9514, 0, -1383, 0, 167, 0
};
*/

static const short comp_coeffs_21[22] __attribute__((aligned(4))) = {
	135, 92, 221, 175, -358, -1228, -1408, 424, 4422, 8734, 10611, 8734, 4422,
	424, -1408, -1228, -358, 175, 221, 92, 135, 0
};

static const short halfband_coeffs_21[22]__attribute__((aligned(4))) = {
	0, 119, 0, -402, 0, 1126, 0, -2818, 0, 10196, 16384, 10196, 0, -2818, 0, 
	1126, 0, -402, 0, 119, 0, 0 
};

static const uint8_t table[] ____cacheline_aligned = {
		 0x00,  0x08,  0x07,  0x0f,  0x06,  0x0e,  0x0d,  0x15, 0x05,  0x0d,  0x0c,  0x14,  0x0b,  0x13,  0x12,  0x1a, 
		 0x04,  0x0c,  0x0b,  0x13,  0x0a,  0x12,  0x11,  0x19, 0x09,  0x11,  0x10,  0x18,  0x0f,  0x17,  0x16,  0x1e, 
		 0x03,  0x0b,  0x0a,  0x12,  0x09,  0x11,  0x10,  0x18, 0x08,  0x10,  0x0f,  0x17,  0x0e,  0x16,  0x15,  0x1d, 
		 0x07,  0x0f,  0x0e,  0x16,  0x0d,  0x15,  0x14,  0x1c, 0x0c,  0x14,  0x13,  0x1b,  0x12,  0x1a,  0x19,  0x21, 
		 0x02,  0x0a,  0x09,  0x11,  0x08,  0x10,  0x0f,  0x17, 0x07,  0x0f,  0x0e,  0x16,  0x0d,  0x15,  0x14,  0x1c, 
		 0x06,  0x0e,  0x0d,  0x15,  0x0c,  0x14,  0x13,  0x1b, 0x0b,  0x13,  0x12,  0x1a,  0x11,  0x19,  0x18,  0x20, 
		 0x05,  0x0d,  0x0c,  0x14,  0x0b,  0x13,  0x12,  0x1a, 0x0a,  0x12,  0x11,  0x19,  0x10,  0x18,  0x17,  0x1f, 
		 0x09,  0x11,  0x10,  0x18,  0x0f,  0x17,  0x16,  0x1e, 0x0e,  0x16,  0x15,  0x1d,  0x14,  0x1c,  0x1b,  0x23, 
		 0x01,  0x09,  0x08,  0x10,  0x07,  0x0f,  0x0e,  0x16, 0x06,  0x0e,  0x0d,  0x15,  0x0c,  0x14,  0x13,  0x1b, 
		 0x05,  0x0d,  0x0c,  0x14,  0x0b,  0x13,  0x12,  0x1a, 0x0a,  0x12,  0x11,  0x19,  0x10,  0x18,  0x17,  0x1f, 
		 0x04,  0x0c,  0x0b,  0x13,  0x0a,  0x12,  0x11,  0x19, 0x09,  0x11,  0x10,  0x18,  0x0f,  0x17,  0x16,  0x1e, 
		 0x08,  0x10,  0x0f,  0x17,  0x0e,  0x16,  0x15,  0x1d, 0x0d,  0x15,  0x14,  0x1c,  0x13,  0x1b,  0x1a,  0x22, 
		 0x03,  0x0b,  0x0a,  0x12,  0x09,  0x11,  0x10,  0x18, 0x08,  0x10,  0x0f,  0x17,  0x0e,  0x16,  0x15,  0x1d, 
		 0x07,  0x0f,  0x0e,  0x16,  0x0d,  0x15,  0x14,  0x1c, 0x0c,  0x14,  0x13,  0x1b,  0x12,  0x1a,  0x19,  0x21, 
		 0x06,  0x0e,  0x0d,  0x15,  0x0c,  0x14,  0x13,  0x1b, 0x0b,  0x13,  0x12,  0x1a,  0x11,  0x19,  0x18,  0x20, 
		 0x0a,  0x12,  0x11,  0x19,  0x10,  0x18,  0x17,  0x1f, 0x0f,  0x17,  0x16,  0x1e,  0x15,  0x1d,  0x1c,  0x24, 
		 0x00,  0x01,  0x01,  0x02,  0x01,  0x02,  0x02,  0x03, 0x01,  0x02,  0x02,  0x03,  0x02,  0x03,  0x03,  0x04, 
		 0x01,  0x02,  0x02,  0x03,  0x02,  0x03,  0x03,  0x04, 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 
		 0x01,  0x02,  0x02,  0x03,  0x02,  0x03,  0x03,  0x04, 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 
		 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 
		 0x01,  0x02,  0x02,  0x03,  0x02,  0x03,  0x03,  0x04, 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 
		 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 
		 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 
		 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 0x04,  0x05,  0x05,  0x06,  0x05,  0x06,  0x06,  0x07, 
		 0x01,  0x02,  0x02,  0x03,  0x02,  0x03,  0x03,  0x04, 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 
		 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 
		 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 
		 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 0x04,  0x05,  0x05,  0x06,  0x05,  0x06,  0x06,  0x07, 
		 0x02,  0x03,  0x03,  0x04,  0x03,  0x04,  0x04,  0x05, 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 
		 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 0x04,  0x05,  0x05,  0x06,  0x05,  0x06,  0x06,  0x07, 
		 0x03,  0x04,  0x04,  0x05,  0x04,  0x05,  0x05,  0x06, 0x04,  0x05,  0x05,  0x06,  0x05,  0x06,  0x06,  0x07, 
		 0x04,  0x05,  0x05,  0x06,  0x05,  0x06,  0x06,  0x07, 0x05,  0x06,  0x06,  0x07,  0x06,  0x07,  0x07,  0x08 	
};

static void cic_info_init(struct cic_info *cic)
{
    uint32_t i = 0;

	cic->ptr = table;
	for(i = 0; i < 5; i++){
	    cic->sig[i] = 0;
		cic->old[i] = 0;
	}
}

static void fir_init(struct fir_16 *fir1, struct fir_16 *fir2, struct fir_16 *fir3)
{
    uint32_t i = 0;

	for(i = 0; i < FIR_BUF_SIZE; i++){
	    fir1->buf[i] = 0;
		fir2->buf[i] = 0;
		fir3->buf[i] = 0;
	}
	fir1->h = comp_coeffs_21;
	fir2->h = halfband_coeffs_21;
	fir3->h = halfband_coeffs_21;
}

void dmic_soft_init(struct dmic_soft_info *dmic)
{
    cic_info_init(&dmic->cic);
	fir_init(&dmic->fir[0], &dmic->fir[1], &dmic->fir[2]);
}

void bios_adjust(short *data, int size)
{
    int i;
    for (i = 0;i < size;i++) {
        data[i] -= 16384;
        data[i] *= 10;
    }
}

/*
 * dmic soft 
 *
 * pdm to pcm 
 * input_data -> cic -> fir(comp) -> fir(halfband) -> fir(halfband)
 *      size    2 * size   size       size/2            size/4 
 *
 * size by byte
 */
uint32_t pdm_to_pcm_sw(uint32_t *pdm, short *pcm, void *comp, void *halfband1,
			void *halfband2, uint32_t size, struct dmic_soft_info *dmic)
{
    struct cic_info *cic = &dmic->cic;
	struct fir_16 *fir = dmic->fir;
	int i;

    if(size & 0x3)
	  return 1;

    cic_filter(pdm, (short *)comp, (size >> 2), cic);
    fir_filter((short *)comp, (short *)halfband1, size, &fir[0]); 
	fir_filter((short *)halfband1, (short *)halfband2, (size >> 1), &fir[1]);
	//fir_filter((short *)halfband2, pcm, (size >> 2), &fir[2]);
	fir_filter1((short *)halfband2, pcm, (size >> 2), &fir[2]);
    bios_adjust((short *)pcm, size >> 2);
	
	return 0;
}

